<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Conditional Modeling Toolkit Tutorials</title>
		<meta charset="UTF-8">
		<meta name="author" content="Lucas Theis">
		<meta name="description" content="Conditional Modeling Toolkit Tutorials">
		<link rel="stylesheet" href="http://yandex.st/highlightjs/7.3/styles/tomorrow.min.css">
		<link rel="stylesheet" type="text/css" href="style.css">
		<script src="http://yandex.st/highlightjs/7.3/highlight.min.js"></script>
		<script type="text/x-mathjax-config">
			MathJax.Hub.Config({
				tex2jax: {
					inlineMath: [['$','$']],
					displayMath: [['$$','$$']],
					skipTags: ["script","noscript","style","textarea","code"],
					processEnvironments: true
				}
			});
		</script>
		<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
		<script>
			hljs.tabReplace = '    ';
			hljs.initHighlightingOnLoad();
		</script>
	</head>
	<body>
		<article>
			<h1>Probabilistic modeling of grayscale images</h1>
				<h2 id="introduction">Introduction</h2>

				<figure>
					<img src="media/newyork.png" alt="New York">
					<figcaption>&copy; Chris Isherwood, 2008</figcaption>
				</figure>

				In this tutorial, we will add some color to our samples. For this, we will have
				to learn a distribution not only over grayscale images, $\mathbf{I} \in
				\mathbb{R}^{M \times N}$, but over color images, $\mathbf{I} \in \mathbb{R}^{M
				\times N \times 3}$.<br>
				<br>
				 We will split this task into two subtasks by separating the grayscale
				 intensities, $\mathbf{I}_0 \in \mathbb{R}^{M \times N}$, from the color
				 information, $\mathbf{I}_1 \in \mathbb{R}^{M \times N \times 2}$.
				 This can be achieved by mapping the RGB pixel values of an image to a 
				 <a href="http://en.wikipedia.org/wiki/YCbCr">different color space</a> using
				 a simple linear transformation. Instead of learning a distribution over
				 $\mathbf{I}$ directly, we are going to learn a distribution for $\mathbf{I}_0$
				 and a conditional distribution for $\mathbf{I}_1$ given $\mathbf{I}_0$.
				 Together, they define a distribution over color images,
				 \begin{align*}
					 P(\mathbf{I}) \propto P(\mathbf{I}_1 \mid \mathbf{I}_0) P(\mathbf{I}_0).
				 \end{align*}

				<h2 id="fitting">Fitting model parameters</h2>

				Since we are going to fit two models in this tutorial, it makes sense to encapsulate
				the training in a function.
					
				<pre><code class="python">from cmt.tools import generate_data_from_image
from cmt.models import MCGSM
from cmt.transforms import WhiteningPreconditioner

def train_model(img, input_mask, output_mask):
	# generate data
	inputs, outputs = generate_data_from_image(
		img, input_mask, output_mask, 120000)

	# split data into training and validation sets
	data_train = inputs[:, :100000], outputs[:, :100000]
	data_valid = inputs[:, 100000:], outputs[:, 100000:]

	# compute normalizing transformation
	pre = WhiteningPreconditioner(*data_train)

	# intialize model
	model = MCGSM(
		dim_in=data_train[0].shape[0],
		dim_out=data_train[1].shape[0],
		num_components=8,
		num_scales=4,
		num_features=30)

	# fit parameters
	model.initialize(*pre(*data_train))
	model.train(*chain(pre(*data_train), pre(*data_valid)),
		parameters={
			'verbosity': 1,
			'max_iter': 1000,
			'threshold': 1e-7,
			'val_iter': 5,
			'val_look_ahead': 10,
			'num_grad': 20,
		})

	return model, pre</code></pre>

				If you are unclear about what this function does, take a look at the previous
				<a href="images.html">tutorial on modeling grayscale images</a>.

				Next, we are going to load an image and transform it to a YCbCr color space.

				<pre><code>from cmt.tools import imread, rgb2ycc

img = rgb2ycc(imread('newyork.png'))</code></pre>

				The first channel of the image, <code>img[:, :, 0]</code>, now contains the
				grayscale information, while the other two channels encode the color information.

				<figure>
					<img src="media/newyork_color_sample.png" alt="New York">
					<figcaption>A sample generated by an image model.</figcaption>
				</figure>
		</article>
	</body>
</html>
